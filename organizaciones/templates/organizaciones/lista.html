<!-- Hereda de la plantilla base.html -->
{% extends "base.html" %}
{% load static %}

<!-- Bloque de contenido principal -->
{% block content %}
<!-- Encabezado con título y botón de nueva organización -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Organizaciones</h2>
    <!-- Botón visible para superusuarios y administradores -->
    {% if user.is_superuser or user.acceso_admin %}
    <a href="{% url 'crear_organizacion' %}" class="btn btn-success">
        Nueva organización
    </a>
    {% endif %}
</div>

<!-- Grid de tarjetas responsivo -->
<div class="row row-cols-1 row-cols-md-2 g-4">
  <!-- Bucle a través de las organizaciones -->
  {% for o in organizaciones %}
    <div class="col">
      <div class="card shadow-sm h-100">
        <!-- Contenedor del logo de la organización -->
        <div class="logo-container">
          {% with logo_name=o.nombre|lower|slugify %}
            {% with logo_file=logo_name %}
              <img src="{% static 'img/logos/'|add:logo_file|add:'.png' %}" 
                   class="card-img-top org-logo" 
                   alt="{{ o.nombre }}"
                   onerror="handleImageError(this, '{{ logo_name }}', '{{ o.nombre }}')"
                   style="height: 200px; object-fit: cover; width: 100%;">
            {% endwith %}
          {% endwith %}
        </div>
        
        <!-- Cuerpo de la tarjeta -->
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ o.nombre }}</h5>
          <p class="card-text flex-grow-1">
              {{ o.descripcion|truncatechars:80 }}
          </p>
          <p class="mb-1"><strong>Email:</strong> {{ o.contacto_email }}</p>
          
          <!-- Botones de acción -->
          <div class="mt-auto">
            <a href="{% url 'detalle_organizacion' o.pk %}" 
               class="btn btn-primary btn-sm">Ver</a>
               
            {% if user.is_superuser or user.acceso_admin %}
            <a href="{% url 'editar_organizacion' o.pk %}" 
               class="btn btn-warning btn-sm">Editar</a>
            <a href="{% url 'eliminar_organizacion' o.pk %}" 
               class="btn btn-danger btn-sm">Eliminar</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <!-- Mensaje cuando no hay organizaciones -->
    <div class="col">
      <div class="alert alert-info">No hay organizaciones registradas.</div>
    </div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Estilos para las tarjetas de organizaciones */
.card {
    transition: transform 0.2s ease-in-out;
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    overflow: hidden;
}

.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
}

.logo-container {
    height: auto;
    background-color: #f8f9fa;
    overflow: hidden;
    padding: 0;
}

.org-logo {
    width: 100%;
    height: 200px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.card:hover .org-logo {
    transform: scale(1.05);
}

/* Ajustes para pantallas pequeñas */
@media (max-width: 768px) {
    .logo-container {
        height: 150px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Mapeo de nombres de organización a nombres de archivo
const logoMappings = {
    'fundacion-vida-silvestre': 'fundacion-vida-silvestre-argentina',
    'cruz-roja-mexicana-iap': 'cruz-roja-mexicana',
    'fundacion-amigos-del-rio-san-juan-fundar': 'fundacion-amigos-rio-san-juan'
};

function handleImageError(img, logoName, orgName) {
    console.log('Error cargando imagen:', img.src);
    
    // Verificar si hay un mapeo especial para este logo
    const mappedName = logoMappings[logoName] || logoName;
    
    // Intentar con diferentes formatos (primero PNG, luego JPG, luego JPEG)
    if (img.src.endsWith('.png')) {
        console.log('Intentando con JPG...');
        img.src = '{% static "img/logos/" %}' + mappedName + '.jpg';
    } 
    else if (img.src.endsWith('.jpg')) {
        console.log('Intentando con JPEG...');
        img.src = '{% static "img/logos/" %}' + mappedName + '.jpeg';
    }
    else if (img.src.endsWith('.jpeg')) {
        console.log('Intentando con WebP...');
        img.src = '{% static "img/logos/" %}' + mappedName + '.webp';
    }
    // Si todo falla, mostramos un mensaje
    else {
        console.log('No se pudo cargar la imagen para:', logoName);
        var container = img.parentNode;
        container.innerHTML = [
            '<div style="height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column;">',
            '    <div class="text-muted">Logo no disponible para:</div>',
            '    <div class="text-primary">', orgName, '</div>',
            '    <div class="small text-muted mt-2">', logoName, '</div>',
            '</div>'
        ].join('');
    }
}
</script>
{% endblock %}